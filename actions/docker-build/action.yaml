name: "Publish Docker image"
description: "Use a Dockerfile to build an `image.tar` file and upload it to GitHub"

inputs:
  dockerfile-path:
    description: "Path to the Dockerfile."
    required: false
    default: "./Dockerfile"
  github-token:
    description: "GitHub token"
    required: true
  image-artifact-name:
    description: "Name of the artifact that contains the Docker image.tar file to push, see https://github.com/actions/upload-artifact (Default is 'image-artifact')."
    required: false
    default: "image-artifact"
  image-name:
    description: "Name of Docker image (Default is the repository name)."
    required: false
    default: ${{ github.event.repository.name }}
  ref:
    description: "Ref to checkout"
    required: false
    default: ${{ github.ref_name }}
runs:
  using: "composite"
  steps:
    - name: Check out repository
      uses: actions/checkout@v3
      with:
        ref: ${{ inputs.ref }}
        token: ${{ inputs.github-token }}

    - name: Build Dockerfile and store them in "build" directory
      run: |
        docker build -t ${{ inputs.image-name }}:${{ github.run_id }} -f ${{ inputs.dockerfile-path }} .
        mkdir build
        docker save ${{ inputs.image-name }}:${{ github.run_id }} > build/${{ inputs.image-name }}.tar
      shell: bash

    - name: Upload Docker image tar artifact
      uses: actions/upload-artifact@v3.1.1
      with:
        name: ${{ inputs.image-artifact-name }}
        path: build
        retention-days: 1
